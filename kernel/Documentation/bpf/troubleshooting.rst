====================
Troubleshooting eBPF
====================

This document should help end-users with troubleshooting their eBPF
programs.  With a primary focus on programs under kernels samples/bpf.

Memory ulimits
==============

The eBPF maps uses locked memory, which is default very low.
Your program likely need to increase resource limit ``RLIMIT_MEMLOCK``
see system call `setrlimit(2)`_.

The ``bpf_create_map`` call will return errno EPERM (Operation not
permitted) when the RLIMIT_MEMLOCK memory size limit is exceeded.

.. _setrlimit(2): http://man7.org/linux/man-pages/man2/setrlimit.2.html

ELF binary
==========

The binary containing the eBPF program, which got generated by the
LLVM compiler, is an normal ELF binary.  For samples/bpf/ this is the
file named xxx_kern.o.

It is possible to inspect this normal ELF file, with tools like ``readelf``. ::

 $ readelf -SW xdp_ddos01_blacklist_kern.o
 There are 8 section headers, starting at offset 0x398:

 Section Headers:
  [Nr] Name           Type       Address          Off    Size   ES Flg Lk Inf Al
  [ 0]                NULL       0000000000000000 000000 000000 00      0   0  0
  [ 1] .strtab        STRTAB     0000000000000000 000320 000072 00      0   0  1
  [ 2] .text          PROGBITS   0000000000000000 000040 000000 00  AX  0   0  4
  [ 3] xdp_prog       PROGBITS   0000000000000000 000040 0001b8 00  AX  0   0  8
  [ 4] .relxdp_prog   REL        0000000000000000 000300 000020 10      7   3  8
  [ 5] maps           PROGBITS   0000000000000000 0001f8 000028 00  WA  0   0  4
  [ 6] license        PROGBITS   0000000000000000 000220 000004 00  WA  0   0  1
  [ 7] .symtab        SYMTAB     0000000000000000 000228 0000d8 18      1   5  8
 Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

From the above output some trivial information can be extracted.  This
is an XDP program, as the defined program section 3 starts with the
letters "xdp".  From the same line ([ 3]) the size column also show
the program size 0001b8 in hex, which is easily converted on the
cmdline to 440 bytes.  Do notice this size is not the JIT'ed program
size::

 $ echo $((0x0001b8))
 440

The loader code samples/bpf/bpf_load.c parses elf file, extract needed
program sections, uses the maps section and relocation section (here
.relxdp_prog type REL) to remap the BPF_PSEUDO_MAP_FD instruction to
point to the correct map (which gets created during parsing of the
maps section, via standard bpf-syscall bpf_create_map).

